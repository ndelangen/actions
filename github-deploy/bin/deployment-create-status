#!/bin/sh
#
# Usage:
#   deployment-create-status <state> <description>
#
# Arguments:
#   $1 - The deployment state
#   $2 - The deployment description
#

BASEDIR=$(dirname "$0")
DEPLOYMENT_ID=$("${BASEDIR}"/deployment-get-id)

DEPLOY_STATE="${1}"
DEPLOY_DESC="${2}"

[ -n "${DEPLOY_DESC}" ] || DEPLOY_DESC="Deploying from GitHub Actions"

echo "Setting status to ${DEPLOY_STATE} for deployment-id '${DEPLOYMENT_ID}'"
wget -O-- \
    --post-data "{\"state\":\"${DEPLOY_STATE}\", \"target_url\":\"https://github.com/${GITHUB_REPOSITORY}/actions\", \"description\":\"${DEPLOY_DESC}\"}" \
    --header "Authorization: token ${GITHUB_TOKEN}" \
    --header "Content-Type: text/json; charset=utf-8" \
    --header "Accept: application/vnd.github.flash-preview+json" \
    https://api.github.com/repos/"${GITHUB_REPOSITORY}"/deployments/"${DEPLOYMENT_ID}"/statuses
